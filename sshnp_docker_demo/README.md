# sshnp_docker_demo

This demo involves using [sshnp](https://github.com/atsign-foundation/sshnoports). [sshnp](https://github.com/atsign-foundation/sshnoports) allows you ssh into any remote device/host without that device having any open ports.

There are two docker containers: `sshnp` and `sshnpd`.

## Getting Started

Follow these steps to get sshnp working on your machine using Docker.

### 1. Prerequisites

1. Install [Docker](https://www.docker.com/products/docker-desktop/) and open it in the background. Check that you have docker installed. Run this in your terminal. Your output should be similar:

```sh
docker --version
Docker version 23.0.5, build bc4487a
```

2. Install [git](https://git-scm.com/downloads) and open it in the background. Check that you have git installed. Run this in your terminal. Your output should be similar:

```sh
git --version
git version 2.39.0
```

2. You will need 2 atSigns and their associated `.atKeys` files, one for each docker container. See [1A. Getting your .atKeys](#1a-getting-your-atkeys) to learn how to get your atKeys.

3. Git clone this repository, and change into the demo directory to ensure it was cloned properly.

```sh
git clone https://github.com/atsign-foundation/at_demos.git
cd at_demos/sshnp_docker_demo
ls
```

#### 1A. Getting your .atKeys

<!-- TODO INCLUDE "GETTING YOUR ATKEYS" VIDEO WHEN IT IS UPLOADED -->

If you already have your `.atKeys` files, you may skip this step.

1. Go to [my.atsign.com/go](https://my.atsign.com/go) and get as many atSigns as you need (2 if you are using Atsign's rendezvous service, 3 if you are using you will be running your own rendezvous service).

2. Once you have checked out with your brand new atSigns, be sure to go through each of them and press the orange "Activate" button. This will open your atSign for activation

3. Use [at_onboarding_cli/at_activate](https://github.com/atsign-foundation/at_libraries/tree/trunk/packages/at_onboarding_cli) (if you prefer a command-line approach) or download one of our [apps](https://atsign.com/apps/) (such as [atmospherePro](https://atsign.com/apps/atmospherepro/)) to utilize the onboarding widget to generate your `.atKeys` files. You will need to generate a `.atKeys` file for each of your atSigns. Be sure to not lose these keys as they are used to authenticate into an atSign's atServer.

### 2. Setting up the sshnpd Docker Container

Next, let's set up the sshnpd container.

1. Put your sshnpd atSign's `.atKeys` file in `sshnpd/keys`. Your file structure should be similar to `sshnpd/keys/@alice_key.atKeys`.

2. Open up a fresh terminal.

3. Run the `docker-build.sh` script inside of `sshnpd/`. 

You may need to enter your user password to allow the script to run `sudo` commands. If run successfully, your terminal sesssion should be running the docker container.

```sh
cd sshnpd
./docker-build.sh
```

Output should be similar to:

```sh
...
atsign@c602e7e77fa9:~$ 
```

4. Once inside the docker container, install sshnpd using `./install_sshnpd -c <@client_atsign> -d <@device_atsign> -n <deviceName>`

```sh
cd sshnp
./install_sshnpd -c @sshnp_atsign -d @sshnpd_atsign -n docker
```

This will install and run the sshnpd inside of the docker container. Optionally, you may run `tmux a` to see logs.

```sh
tmux a
```

Once the daemon is running, you may move onto [Step 4. Setting up sshnp](#4-setting-up-sshnp). The next steps are for setting up the daemon manually in case something goes wrong.

5. Optionally, you can ensure that the daemon has started by attaching to the tmux session which was started by the `install_sshnpd` script.

To attach to the tmux session, simply run:

```sh
tmux a
```

You should see a line similar to the following, if the daemon started successfully:

```
INFO|2023-06-07 16:13:34.097561|Monitor (@22easy)|monitor started for @22easy with last notification time: null 
```

To detach, press `ctrl+b` and then `d`.

6. If your daemon has not been started up correctly and want to start it up again, 

First ensure the tmux session is killed with `tmux kill-ses` and then run the `sshnpd@sshnp_atsign` script inside of `~/.local/bin`. This is a custom script generated by the `install_sshnpd` script.

Replace `@sshnp_atsign` with the atSign you are using for `sshnp`.

```sh
tmux kill-ses
cd ~/.local/bin
./sshnpd@sshnp_atsign
```

### 3. Setting up sshnp

1. Put your sshnp atSign's `.atKeys` inside of `sshnp/keys/`. Your file structure should be similar to `sshnp/keys/@alice_key.atKeys`.

2. Open up a fresh terminal.

3. Next, let's build the `sshnp` docker container using the `docker-build.sh` shell script.

```sh
cd sshnp
./docker-build.sh
```

You may need to enter your password to allow the script to run `sudo` commands.

If run successfully, your terminal sesssion should be running the docker container:

```sh
atsign@f868301cecf8:~$ 
```

4. Run the `install_sshnp` script from within the `sshnp` directory inside the docker container. `./install_sshnp -c <@client_atsign> -d <@device_atsign> -h <region am, eu, ap>`

```sh
cd sshnp
./install_sshnp -c @sshnp_atsign -d @sshnpd_atsign -h am
```

5. Now run the custom sshnp script it generated.

```sh
~/.local/bin/sshnp@sshnpd_atsign docker
```

6. You should receive an ssh command to run after running the `sshnp` script. Copy and run this command.

Running the `sshnp` script should give you an output at the end similar to:

```sh
ssh -p 44743 atsign@localhost -i /atsign/.ssh/id_ed25519 
```

7. You should be ssh'd into the other docker container. (Hurray!)

```sh
atsign@77fe899b6732:~$ ps -a
  PID TTY          TIME CMD
   27 pts/0    00:00:00 bash
   76 pts/1    00:00:00 sshnpd@soccer99
   79 pts/1    00:00:01 dart:sshnpd
  224 pts/2    00:00:00 ps
atsign@77fe899b6732:~$ echo yay
yay
```

## Structure

<!-- TODO -->

## The Dockerfile

<!-- TODO -->

## Usage

Usage of each of the binaries (taken from the [sshnp](https://github.com/atsign-foundation/sshnoports) repo)

`sshnp` usage (example: `./sshnp -f @soccer99 -t @66dear32 -h @48leo -d docker -s id_ed25519.pub -v`)

```sh
Version : 3.1.2
-k, --key-file             Sending atSign's atKeys file if not in ~/.atsign/keys/
-f, --from (mandatory)     Sending atSign
-t, --to (mandatory)       Send a notification to this atSign
-d, --device               Send a notification to this device
                           (defaults to "default")
-h, --host (mandatory)     atSign of sshrvd daemon or FQDN/IP address to connect back to 
-p, --port                 TCP port to connect back to (only required if --host specified a FQDN/IP)
                           (defaults to "22")
-l, --local-port           Reverse ssh port to listen on, on your local machine, by sshnp default finds a spare port
                           (defaults to "0")
-s, --ssh-public-key       Public key file from ~/.ssh to be appended to authorized_hosts on the remote device
                           (defaults to "false")
-o, --local-ssh-options    Add these commands to the local ssh command
-v, --[no-]verbose         More logging
-r, --[no-]rsa             Use RSA 4096 keys rather than the default ED25519 keys
```

`sshnpd` usage (example: `./sshnpd -a @66dear32 -m @the50 -d docker -s -u -v`) 

```sh
-k, --keyFile                Sending atSign's keyFile if not in ~/.atsign/keys/
-a, --atsign (mandatory)     atSign of this device
-m, --manager (mandatory)    Managers atSign, that this device will accept triggers from
-d, --device                 Send a trigger to this device, allows multiple devices share an atSign
                             (defaults to "default")
-s, --[no-]sshpublickey      Update authorized_keys to include public key from sshnp
-u, --[no-]username          Send username to the manager to allow sshnp to display username in command line
-v, --[no-]verbose           More logging
```

`sshrvd` usage (example: `./sshrvd -a @48leo -i 172.17.0.2 -v -s`)

```sh
Version : 3.1.2
-k, --key-file              atSign's atKeys file if not in ~/.atsign/keys/
-a, --atsign (mandatory)    atSign for sshrvd
-m, --manager               Managers atSign that sshrvd will accept requests from. Default is any atSign can use sshrvd
                            (defaults to "open")
-i, --ip (mandatory)        FQDN/IP address sent to clients
-v, --[no-]verbose          More logging
-s, --[no-]snoop            Snoop on traffic passing through service
```
